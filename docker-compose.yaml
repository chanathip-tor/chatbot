

version: "3.9"

services:
  # 1) Build the project image once and reuse
  vectorstore-init:
    build: .
    image: agentic-chatbot:latest
    command: >-
      sh -lc "uv run vectorstore/setting.py"
    env_file:
      - .env
    volumes:
      - chroma_db:/app/vectorstore/chroma_db
    restart: "no"

  api:
    image: agentic-chatbot:latest
    command: >-
      sh -lc "uv run uvicorn apps.api:app --host 0.0.0.0 --port 8000"
    env_file:
      - .env
    depends_on:
      vectorstore-init:
        condition: service_completed_successfully
    ports:
      - "8000:8000"
    volumes:
      - chroma_db:/app/vectorstore/chroma_db
    restart: unless-stopped

  ui:
    image: agentic-chatbot:latest
    command: >-
      sh -lc "uv run streamlit run apps/streamlitUI.py --server.port 8501 --server.address 0.0.0.0"
    env_file:
      - .env
    depends_on:
      vectorstore-init:
        condition: service_completed_successfully
      api:
        condition: service_started
    ports:
      - "8501:8501"
    volumes:
      - chroma_db:/app/vectorstore/chroma_db
    restart: unless-stopped

volumes:
  chroma_db: